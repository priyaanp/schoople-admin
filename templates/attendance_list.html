<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance List</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>Attendance List</h2>

        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="grade-filter">Grade:</label>
                <select id="grade-filter" class="form-control">
                    <option value="">All Grades</option>
                    {% for grade in grades %}
                    <option value="{{ grade.id }}">{{ grade.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="section-filter">Section:</label>
                <select id="section-filter" class="form-control">
                    <option value="">All Sections</option>
                    {% for section in sections %}
                    <option value="{{ section.id }}">{{ section.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="date-filter">Date:</label>
                <input type="date" id="date-filter" class="form-control">
            </div>
            <div class="col-md-3">
                <button id="filter-btn" class="btn btn-primary mt-4">Filter</button>
            </div>
        </div>

        <!-- DataTable -->
        <table id="attendanceTable" class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Student</th>
                    <th>Staff</th>
                    <th>Class</th>
                    <th>Attendance Date</th>
                    <th>Is Hourly</th>
                    <th>Period</th>
                    <th>Time Slot</th>
                    <th>Actions</th>
                </tr>
            </thead>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function () {
            const table = $('#attendanceTable').DataTable({
                ajax: {
                    url: '/attendance',
                    data: function (d) {
                        d.grade_id = $('#grade-filter').val();
                        d.section_id = $('#section-filter').val();
                        d.attendence_date = $('#date-filter').val();
                    },
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'id' },
                    { data: 'student' },
                    { data: 'staff' },
                    { data: 'class_id' },
                    { data: 'attendence_date' },
                    { data: 'is_hourly' },
                    { data: 'period' },
                    { data: 'time_slot' },
                    {
                        data: 'id',
                        render: function (data) {
                            return `
                                <button class="btn btn-edit btn-sm btn-primary" data-id="${data}">Edit</button>
                                <button class="btn btn-delete btn-sm btn-danger" data-id="${data}">Delete</button>
                            `;
                        }
                    }
                ]
            });

            // Filter button click handler
            $('#filter-btn').on('click', function () {
                table.ajax.reload();
            });

            // Edit and Delete button functionality
            $(document).on('click', '.btn-edit', function () {
                const id = $(this).data('id');
                window.location.href = `/attendance/edit/${id}`;
            });

            $(document).on('click', '.btn-delete', function () {
                const id = $(this).data('id');
                if (confirm('Are you sure you want to delete this record?')) {
                    $.ajax({
                        url: `/attendance/delete/${id}`,
                        type: 'DELETE',
                        success: function () {
                            alert('Attendance record deleted successfully.');
                            table.ajax.reload();
                        },
                        error: function () {
                            alert('Failed to delete the record.');
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
