<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Marks</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h2>Exam Marks Management</h2>

    <!-- Filters -->
    <div class="row">
        <div class="col-md-3">
            <label for="academic-year">Academic Year:</label>
            <select id="academic-year" class="form-control">
                <option value="">Select Academic Year</option>
                {% for year in academic_years %}
                <option value="{{ year.id }}" {% if year.active %}selected{% endif %}>
                    {{ year.start_date }} - {{ year.end_date }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="grade">Grade:</label>
            <select id="grade" class="form-control">
                <option value="">Select Grade</option>
                {% for grade in grades %}
                <option value="{{ grade.id }}">{{ grade.title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="section">Section:</label>
            <select id="section" class="form-control">
                <option value="">Select Section</option>
                {% for section in sections %}
                <option value="{{ section.id }}">{{ section.title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="term">Term:</label>
            <select id="term" class="form-control">
                <option value="First">First</option>
                <option value="Second">Second</option>
                <option value="Third">Third</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="subject">Subject:</label>
            <select id="subject" class="form-control">
                <option value="">Select Subject</option>
                {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.title }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Search Button -->
    <div class="mt-3">
        <button id="search-btn" class="btn btn-primary">Search</button>
    </div>

    <!-- Marks and Weightage -->
    <div class="row mt-3">
        <div class="col-md-3">
            <label for="marks-out-of">Marks Out Of:</label>
            <input type="number" id="marks-out-of" class="form-control" placeholder="Total Marks">
        </div>
        <div class="col-md-3">
            <label for="weightage">Weightage:</label>
            <input type="number" id="weightage" class="form-control" placeholder="Weightage">
        </div>

    </div>

    <!-- Student List -->
    <div id="students-container" class="mt-4"></div>

    <!-- Save Button -->
    <div class="mt-3">
        <button id="save-btn" class="btn btn-success">Save Marks</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    // Handle Search
    $('#search-btn').on('click', function () {
    const academicYearId = $('#academic-year').val();
    const gradeId = $('#grade').val();
    const sectionId = $('#section').val();
    const term = $('#term').val();
    const subjectId = $('#subject').val();

    if (!academicYearId || !gradeId || !sectionId || !term || !subjectId) {
        alert('Please select all filters.');
        return;
    }

    // Fetch students and global marks data
    $.post('/exam-marks/students', {
        academic_year_id: academicYearId,
        grade_id: gradeId,
        section_id: sectionId,
        term: term,
        subject_id: subjectId
    }, function (response) {
        // Update the global marks fields
        $('#marks-out-of').val(response.marks_out_of);
        $('#weightage').val(response.weightage);
        if (!response || !response.students) {            
            $('#students-container').html('<p>No students found for the selected criteria.</p>');
            return;
        }
        // Render the student list
        let html = `
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Marks Obtained</th>
                    </tr>
                </thead>
                <tbody>
        `;
        response.students.forEach(student => {
            html += `
                <tr>
                    <td>${student.name}</td>
                    <td>
                        <input type="number" class="form-control mark-input" 
                            data-student-id="${student.id}" 
                            value="${student.marks_obtained}">
                    </td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        $('#students-container').html(html);
    }).fail(function () {
        alert('Failed to fetch students. Please try again.');
    });
});



    // Handle Save
    $('#save-btn').on('click', function () {
        const marksOutOf = $('#marks-out-of').val();
        const weightage = $('#weightage').val();
        const term = $('#term').val();
        const subjectId = $('#subject').val();
        const students = [];

        // Collect student data
        $('#students-container tbody tr').each(function () {
            const studentId = $(this).find('.mark-input').data('student-id');
            const marksObtained = $(this).find('.mark-input').val();
            if (studentId) {
                students.push({
                    id: studentId,
                    marks_obtained: marksObtained || null
                });
            }
        });

        // Prepare payload
        const payload = {
            term,
            subject_id: subjectId,
            marks_out_of: marksOutOf,
            weightage,
            students
        };

        $.ajax({
            url: '/exam-marks/save',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (response) {
                alert(response.message);
            },
            error: function () {
                alert('Failed to save marks. Please try again.');
            }
        });
    });
});
</script>
</body>
</html>
